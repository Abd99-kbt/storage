<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الفوترة المتكامل - إدارة المستودعات</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');

        * {
            font-family: 'Cairo', sans-serif;
        }

        .invoice-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .invoice-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .invoice-status {
            position: absolute;
            top: 16px;
            left: 16px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .invoice-amount {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }

        .invoice-preview {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            margin-bottom: 16px;
            position: relative;
        }

        .invoice-header {
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
        }

        .invoice-table th,
        .invoice-table td {
            padding: 8px 12px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        .invoice-table th {
            background: #f8fafc;
            font-weight: 600;
        }

        .invoice-total {
            background: #f8fafc;
            border-top: 2px solid #3b82f6;
            font-weight: bold;
            font-size: 18px;
        }

        .payment-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-paid {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .modal-xl {
            max-width: 1200px;
        }

        .invoices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
        }

        .invoice-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .invoice-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .invoice-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }

        .action-btn {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .invoice-timeline {
            position: relative;
            padding-right: 30px;
        }

        .invoice-timeline::before {
            content: '';
            position: absolute;
            right: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #10b981 0%, #3b82f6 100%);
        }

        .timeline-item {
            position: relative;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            right: -22px;
            top: 16px;
            width: 10px;
            height: 10px;
            background: #3b82f6;
            border-radius: 50%;
            border: 2px solid white;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .payment-method {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .payment-method.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .payment-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 8px;
        }

        .invoice-form {
            background: white;
            border-radius: 16px;
            padding: 32px;
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .form-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .tax-calculation {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        /* Mobile Responsive Improvements */
        @media (max-width: 640px) {
            .container {
                padding: 16px;
            }

            .invoice-card {
                padding: 16px;
            }

            .invoice-preview {
                padding: 16px;
                margin-bottom: 12px;
            }

            .invoice-table th,
            .invoice-table td {
                padding: 6px 8px;
                font-size: 12px;
            }

            .invoices-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .invoice-actions {
                flex-direction: column;
                gap: 8px;
            }

            .action-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .chart-container {
                padding: 16px;
            }

            .payment-methods {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .payment-method {
                padding: 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .form-section {
                padding: 16px;
                margin-bottom: 16px;
            }

            .invoice-form {
                padding: 20px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">نظام الفوترة المتكامل</h1>
                    <p class="text-gray-600">إدارة شاملة للفواتير والمدفوعات والتسليم</p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="seedSampleInvoices()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                        <i class="fas fa-database ml-2"></i>إضافة بيانات تجريبية
                    </button>
                    <button onclick="showInvoiceAnalytics()" class="bg-gradient-to-r from-purple-500 to-blue-600 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                        <i class="fas fa-chart-line ml-2"></i>التحليلات
                    </button>
                    <button onclick="exportInvoicesPDF()" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                        <i class="fas fa-file-pdf ml-2"></i>تصدير PDF
                    </button>
                    <button onclick="showCreateInvoiceModal()" class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-200">
                        <i class="fas fa-plus ml-2"></i>إنشاء فاتورة جديدة
                    </button>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- Search Input -->
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">البحث</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="ابحث برقم الفاتورة أو اسم الزبون..." class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="clearSearch()" class="absolute left-3 top-3 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">الحالة</label>
                    <select id="statusFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">جميع الحالات</option>
                        <option value="draft">مسودة</option>
                        <option value="approved">معتمدة</option>
                        <option value="paid">مدفوعة</option>
                        <option value="delivered">مسلمة</option>
                        <option value="cancelled">ملغية</option>
                    </select>
                </div>

                <!-- Date From -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">من تاريخ</label>
                    <input type="date" id="dateFromFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Date To -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">إلى تاريخ</label>
                    <input type="date" id="dateToFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- Filter Actions -->
            <div class="flex justify-between items-center mt-4">
                <div class="flex space-x-3">
                    <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200">
                        <i class="fas fa-search ml-2"></i>تطبيق البحث
                    </button>
                    <button onclick="clearAllFilters()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-all duration-200">
                        <i class="fas fa-eraser ml-2"></i>مسح المرشحات
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    عرض <span id="filteredCount">0</span> من <span id="totalCount">0</span> فاتورة
                </div>
            </div>
        </div>

        <!-- Invoice Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="invoice-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">مسودة</p>
                        <p class="text-3xl font-bold text-gray-800" id="draftInvoices">8</p>
                        <p class="text-gray-600 text-sm mt-1">
                            <i class="fas fa-file ml-1"></i>في انتظار المراجعة
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-file text-gray-600"></i>
                    </div>
                </div>
            </div>

            <div class="invoice-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">معتمدة</p>
                        <p class="text-3xl font-bold text-gray-800" id="approvedInvoices">12</p>
                        <p class="text-blue-600 text-sm mt-1">
                            <i class="fas fa-check ml-1"></i>جاهزة للدفع
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-blue-600"></i>
                    </div>
                </div>
            </div>

            <div class="invoice-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">مدفوعة</p>
                        <p class="text-3xl font-bold text-gray-800" id="paidInvoices">25</p>
                        <p class="text-green-600 text-sm mt-1">
                            <i class="fas fa-dollar-sign ml-1"></i>تم السداد
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-green-600"></i>
                    </div>
                </div>
            </div>

            <div class="invoice-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">مسلمة</p>
                        <p class="text-3xl font-bold text-gray-800" id="deliveredInvoices">18</p>
                        <p class="text-purple-600 text-sm mt-1">
                            <i class="fas fa-truck ml-1"></i>تم التسليم
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-truck text-purple-600"></i>
                    </div>
                </div>
            </div>

            <div class="invoice-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">الإجمالي</p>
                        <p class="text-3xl font-bold text-gray-800" id="totalInvoices">63</p>
                        <p class="text-gray-600 text-sm mt-1">
                            <i class="fas fa-calculator ml-1"></i>جميع الفواتير
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-calculator text-gray-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="chart-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">توزيع الفواتير حسب الحالة</h3>
                <div id="invoicesStatusChart" style="height: 350px;"></div>
            </div>

            <div class="chart-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">الإيرادات الشهرية</h3>
                <div id="invoicesRevenueChart" style="height: 350px;"></div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <button onclick="showBulkInvoiceModal()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl hover:shadow-lg transition-all duration-200 text-center">
                <i class="fas fa-layer-group text-2xl mb-3 block"></i>
                <div class="font-medium">العمليات المجمعة</div>
                <div class="text-sm opacity-90">إدارة متعددة للفواتير</div>
            </button>

            <button onclick="showPaymentModal()" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-xl hover:shadow-lg transition-all duration-200 text-center">
                <i class="fas fa-credit-card text-2xl mb-3 block"></i>
                <div class="font-medium">المدفوعات</div>
                <div class="text-sm opacity-90">إدارة المدفوعات</div>
            </button>

            <button onclick="showDeliveryModal()" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-xl hover:shadow-lg transition-all duration-200 text-center">
                <i class="fas fa-truck text-2xl mb-3 block"></i>
                <div class="font-medium">التسليم</div>
                <div class="text-sm opacity-90">تتبع التسليم</div>
            </button>

            <button onclick="showTaxModal()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-xl hover:shadow-lg transition-all duration-200 text-center">
                <i class="fas fa-percentage text-2xl mb-3 block"></i>
                <div class="font-medium">الضرائب</div>
                <div class="text-sm opacity-90">حساب الضرائب</div>
            </button>
        </div>

        <!-- Invoices Grid -->
        <div class="invoices-grid">
            <div class="invoice-card">
                <div class="invoice-status bg-green-500 text-white">مدفوعة</div>
                <div class="invoice-amount bg-green-100 text-green-800">12,500 ليرة سورية</div>
                <div class="invoice-header">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">فاتورة INV-2025-001</h3>
                            <p class="text-gray-600 text-sm">شركة الأعمال الحديثة</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">رقم الطلب</p>
                            <p class="font-medium">#1234</p>
                        </div>
                    </div>
                </div>

                <div class="invoice-preview">
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>المادة</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ورق أبيض A4</td>
                                <td>25 طبقة</td>
                                <td>300 ليرة سورية</td>
                                <td>7,500 ليرة سورية</td>
                            </tr>
                            <tr>
                                <td>كرتون بني</td>
                                <td>25 طبقة</td>
                                <td>200 ليرة سورية</td>
                                <td>5,000 ليرة سورية</td>
                            </tr>
                            <tr class="invoice-total">
                                <td colspan="3">الإجمالي</td>
                                <td>12,500 ليرة سورية</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button onclick="viewInvoice('INV-2025-001')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200">
                            <i class="fas fa-eye ml-2"></i>عرض
                        </button>
                        <button onclick="printInvoice('INV-2025-001')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-200">
                            <i class="fas fa-print ml-2"></i>طباعة
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">تاريخ الإصدار</p>
                        <p class="font-medium">2025-09-28</p>
                    </div>
                </div>
            </div>

            <div class="invoice-card">
                <div class="invoice-status bg-blue-500 text-white">معتمدة</div>
                <div class="invoice-amount bg-blue-100 text-blue-800">18,750 ليرة سورية</div>
                <div class="invoice-header">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">فاتورة INV-2025-002</h3>
                            <p class="text-gray-600 text-sm">مؤسسة التجارة العالمية</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">رقم الطلب</p>
                            <p class="font-medium">#1235</p>
                        </div>
                    </div>
                </div>

                <div class="invoice-preview">
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>المادة</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ورق ملون</td>
                                <td>30 طبقة</td>
                                <td>400 ليرة سورية</td>
                                <td>12,000 ليرة سورية</td>
                            </tr>
                            <tr>
                                <td>ألمنيوم ورقي</td>
                                <td>30 طبقة</td>
                                <td>225 ليرة سورية</td>
                                <td>6,750 ليرة سورية</td>
                            </tr>
                            <tr class="invoice-total">
                                <td colspan="3">الإجمالي</td>
                                <td>18,750 ليرة سورية</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button onclick="approveInvoice('INV-2025-002')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-200">
                            <i class="fas fa-check ml-2"></i>اعتماد الدفع
                        </button>
                        <button onclick="viewInvoice('INV-2025-002')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200">
                            <i class="fas fa-eye ml-2"></i>عرض
                        </button>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">تاريخ الإصدار</p>
                        <p class="font-medium">2025-09-27</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Creation Modal -->
        <div id="createInvoiceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full mx-4">
                <div class="bg-gradient-to-r from-green-500 to-blue-600 px-6 py-4 border-b rounded-t-2xl">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-white">إنشاء فاتورة جديدة</h3>
                        <div class="flex items-center space-x-3">
                            <button onclick="goBackFromModal('createInvoiceModal')" class="text-white hover:text-gray-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                <i class="fas fa-arrow-right text-lg"></i>
                            </button>
                            <button onclick="closeCreateInvoiceModal()" class="text-white hover:text-gray-300 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
</div>
                <form id="invoiceForm" onsubmit="createInvoice(event)" class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Invoice Details -->
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">تفاصيل الفاتورة</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">رقم الفاتورة</label>
                                    <input type="text" id="invoiceNumber" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="INV-2025-XXX">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم الزبون</label>
                                    <input type="text" id="invoiceCustomerName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">رقم الطلب المرتبط</label>
                                    <select id="invoiceOrderId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">اختر الطلب</option>
                                        <option value="1234">#1234 - شركة الأعمال الحديثة</option>
                                        <option value="1235">#1235 - مؤسسة التجارة العالمية</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الإصدار</label>
                                    <input type="date" id="invoiceDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الاستحقاق</label>
                                    <input type="date" id="invoiceDueDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Invoice Items -->
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">عناصر الفاتورة</h4>
                            <div id="invoiceItemsContainer">
                                <div class="invoice-item mb-4">
                                    <div class="grid grid-cols-12 gap-4">
                                        <div class="col-span-4">
                                            <input type="text" placeholder="اسم المادة" class="w-full p-2 border border-gray-300 rounded-lg" required>
                                        </div>
                                        <div class="col-span-2">
                                            <input type="number" placeholder="الكمية" class="w-full p-2 border border-gray-300 rounded-lg quantity-input" required min="1" step="1">
                                        </div>
                                        <div class="col-span-3">
                                            <input type="number" placeholder="السعر" class="w-full p-2 border border-gray-300 rounded-lg price-input" required min="0" step="0.01">
                                        </div>
                                        <div class="col-span-2">
                                            <input type="number" placeholder="الإجمالي" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 total-input" readonly>
                                        </div>
                                        <div class="col-span-1">
                                            <button type="button" class="text-red-600 hover:text-red-800 p-2 remove-item">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" onclick="addInvoiceItem()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full">
                                <i class="fas fa-plus ml-2"></i>إضافة عنصر
                            </button>
                        </div>
                    </div>

                    <!-- Tax and Total -->
                    <div class="mt-8">
                        <div class="tax-calculation">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ قبل الضريبة</label>
                                    <input type="number" id="subtotalAmount" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الضريبة (15%)</label>
                                    <input type="number" id="taxAmount" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ الإجمالي</label>
                                    <input type="number" id="totalAmount" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 font-bold text-lg">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 mt-8">
                        <button type="button" onclick="closeCreateInvoiceModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            إلغاء
                        </button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-save ml-2"></i>إنشاء الفاتورة
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        let allInvoices = [];
        let allOrders = [];

        console.log('=== INVOICES PAGE DEBUG INFO ===');
        console.log('API_BASE_URL:', API_BASE_URL);
        console.log('Auth Token from localStorage:', authToken);
        console.log('Current User from localStorage:', currentUser);

        // Fix API calls to use full URL with CORS proxy if needed
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            if (url.startsWith('/api/')) {
                url = 'http://localhost:3000' + url;
            }
            console.log('Fetch intercepted:', url, options);
            return originalFetch(url, options);
        };

        // API helper functions
        async function apiRequest(endpoint, options = {}) {
            const url = endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            if (authToken) {
                config.headers['Authorization'] = `Bearer ${authToken}`;
            }

            return fetch(url, config);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INVOICES PAGE INITIALIZATION ===');
            console.log('Invoices DOM Content Loaded - Checking authentication...');
            console.log('Auth Token:', authToken);
            console.log('Current User:', currentUser);

            // Check authentication
            if (!authToken || !currentUser) {
                console.log('No auth token or user found, redirecting to login...');
                window.location.href = 'index.html';
                return;
            }

            // Check if user has permission to manage invoices
            if (!hasPermission('manage_invoices')) {
                console.log('User does not have invoices management permission');
                showMessage('error', 'ليس لديك صلاحية للوصول إلى إدارة الفواتير');
                return;
            }

            console.log('User has permission, testing backend connection...');
            // Test backend connection first
            testBackendConnection().then(() => {
                console.log('Backend connection successful, loading data...');
                loadInvoicesData();
                loadOrdersForDropdown();
                setupEventListeners();
                setupFilterListeners();
            }).catch((error) => {
                console.error('Backend connection test failed:', error);
                showMessage('error', 'لا يمكن الاتصال بالخادم. تأكد من أن الخادم يعمل على المنفذ 3000');
            });
        });

        // Test backend connection
        async function testBackendConnection() {
            try {
                console.log('=== TESTING BACKEND CONNECTION ===');
                console.log('Testing URL: http://localhost:3000/api/invoices');
                console.log('Auth token:', authToken ? 'Present' : 'Missing');

                const response = await fetch('http://localhost:3000/api/invoices', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('Test response status:', response.status);
                console.log('Test response ok:', response.ok);

                if (response.ok || response.status === 401 || response.status === 403) {
                    console.log('Backend connection successful');
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('Test failed with status:', response.status, 'Response:', errorText);
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Backend connection failed:', error);
                throw error;
            }
        }

        // Check permissions
        function hasPermission(permission) {
            if (!currentUser || !currentUser.userType) return false;
            const permissions = {
                admin: ['manage_users', 'manage_warehouses', 'manage_materials', 'manage_orders', 'manage_invoices', 'view_reports', 'manage_settings'],
                warehouse_manager: ['manage_warehouses', 'manage_materials', 'transfer_materials', 'view_reports'],
                cutting_manager: ['manage_materials', 'manage_orders', 'view_reports', 'approve_orders'],
                sorting_manager: ['manage_materials', 'manage_orders', 'view_reports', 'approve_orders'],
                accountant: ['manage_invoices', 'view_reports', 'export_data', 'manage_orders'],
                order_tracker: ['manage_orders', 'view_reports'],
                delivery_manager: ['manage_orders', 'manage_invoices', 'view_reports'],
                sales: ['manage_orders', 'view_reports']
            };
            return permissions[currentUser.userType] && permissions[currentUser.userType].includes(permission);
        }

        // Load invoices data from backend
        async function loadInvoicesData(filters = {}) {
            try {
                console.log('=== LOADING INVOICES DATA ===');
                console.log('Making API call to /api/invoices with filters:', filters);
                console.log('Auth token being sent:', authToken ? 'YES' : 'NO');

                // Build query parameters
                const queryParams = new URLSearchParams();

                if (filters.status) queryParams.append('status', filters.status);
                if (filters.customer) queryParams.append('customer', filters.customer);
                if (filters.date_from) queryParams.append('date_from', filters.date_from);
                if (filters.date_to) queryParams.append('date_to', filters.date_to);

                const url = `/api/invoices${queryParams.toString() ? '?' + queryParams.toString() : ''}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    allInvoices = await response.json();
                    console.log('Invoices loaded successfully:', allInvoices.length, 'invoices');
                    updateInvoicesGrid(allInvoices);
                    updateInvoiceStatistics(allInvoices);
                    loadInvoiceCharts(allInvoices);

                    // Update filter counts
                    updateFilterCounts(allInvoices);
                } else {
                    const errorText = await response.text();
                    console.error('API Error response:', errorText);
                    showMessage('error', 'خطأ في تحميل بيانات الفواتير');
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
                showMessage('error', 'حدث خطأ أثناء تحميل بيانات الفواتير');
            }
        }

        // Apply filters function
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFromFilter = document.getElementById('dateFromFilter').value;
            const dateToFilter = document.getElementById('dateToFilter').value;

            const filters = {};

            if (searchTerm) {
                // Search in both invoice number and customer name
                filters.customer = searchTerm;
            }

            if (statusFilter) {
                filters.status = statusFilter;
            }

            if (dateFromFilter) {
                filters.date_from = dateFromFilter;
            }

            if (dateToFilter) {
                filters.date_to = dateToFilter;
            }

            console.log('Applying filters:', filters);
            loadInvoicesData(filters);
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';

            loadInvoicesData();
        }

        // Clear search only
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            applyFilters();
        }

        // Update filter counts
        function updateFilterCounts(invoices) {
            const totalCount = invoices.length;
            const filteredCount = invoices.length; // Since we're filtering on backend, both are same

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('filteredCount').textContent = filteredCount;
        }

        // Setup filter event listeners
        function setupFilterListeners() {
            // Search input with debounce
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 500);
            });

            // Filter dropdowns
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
            document.getElementById('dateToFilter').addEventListener('change', applyFilters);
        }

        // Load orders for dropdown (only completed orders)
        async function loadOrdersForDropdown() {
            try {
                const response = await fetch('/api/orders?status=completed', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    allOrders = await response.json();
                    const select = document.getElementById('invoiceOrderId');
                    select.innerHTML = '<option value="">اختر الطلب</option>';

                    if (allOrders.length === 0) {
                        select.innerHTML = '<option value="">لا توجد طلبات مكتملة لإنشاء فواتير</option>';
                        return;
                    }

                    allOrders.forEach(order => {
                        const option = document.createElement('option');
                        option.value = order.id;
                        option.textContent = `#${order.order_number} - ${order.customer_name} (${order.total_amount} ليرة سورية)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                const select = document.getElementById('invoiceOrderId');
                select.innerHTML = '<option value="">خطأ في تحميل الطلبات</option>';
            }
        }

        // Update invoices grid
        function updateInvoicesGrid(invoices) {
            const grid = document.querySelector('.invoices-grid');
            if (!grid) return;

            grid.innerHTML = '';

            if (invoices.length === 0) {
                grid.innerHTML = '<p class="text-center text-gray-600 py-12">لا توجد فواتير للعرض</p>';
                return;
            }

            invoices.forEach(invoice => {
                const invoiceCard = document.createElement('div');
                invoiceCard.className = 'invoice-card';
                invoiceCard.innerHTML = `
                    <div class="invoice-status ${getStatusClass(invoice.status)}">${getStatusText(invoice.status)}</div>
                    <div class="invoice-amount bg-gray-100 text-gray-800">${invoice.total_amount ? invoice.total_amount.toLocaleString() + ' ليرة سورية' : 'غير محدد'}</div>
                    <div class="invoice-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">فاتورة ${invoice.invoice_number}</h3>
                                <p class="text-gray-600 text-sm">${invoice.customer_name}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">رقم الطلب</p>
                                <p class="font-medium">${invoice.order_number || 'غير محدد'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="invoice-preview">
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>المادة</th>
                                    <th>الكمية</th>
                                    <th>السعر</th>
                                    <th>الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items && invoice.items.length > 0 ?
                                    invoice.items.slice(0, 3).map(item => `
                                        <tr>
                                            <td>${item.material_name}</td>
                                            <td>${item.quantity}</td>
                                            <td>${item.unit_price} ليرة سورية</td>
                                            <td>${item.total_price} ليرة سورية</td>
                                        </tr>
                                    `).join('') +
                                    (invoice.items.length > 3 ? `
                                        <tr>
                                            <td colspan="4" class="text-center text-blue-600">
                                                و ${invoice.items.length - 3} عنصر آخر...
                                            </td>
                                        </tr>
                                    ` : '')
                                    :
                                    '<tr><td colspan="4" class="text-center text-gray-500">تفاصيل العناصر غير متوفرة</td></tr>'
                                }
                                <tr class="invoice-total">
                                    <td colspan="3">الإجمالي</td>
                                    <td>${invoice.total_amount ? invoice.total_amount.toLocaleString() + ' ليرة سورية' : 'غير محدد'}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between items-center">
                        <div class="flex space-x-2">
                            <button data-action="view" data-invoice="${invoice.invoice_number}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200">
                                <i class="fas fa-eye ml-2"></i>عرض
                            </button>
                            <button data-action="print" data-invoice="${invoice.invoice_number}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-200">
                                <i class="fas fa-print ml-2"></i>طباعة
                            </button>
                            ${invoice.status === 'draft' ? `<button data-action="approve" data-invoice="${invoice.invoice_number}" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all duration-200">
                                <i class="fas fa-check ml-2"></i>اعتماد
                            </button>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">تاريخ الإصدار</p>
                            <p class="font-medium">${invoice.created_at ? new Date(invoice.created_at).toLocaleDateString('ar-SA') : 'غير محدد'}</p>
                        </div>
                    </div>
                `;
                grid.appendChild(invoiceCard);
            });

            // Setup event delegation for dynamically created buttons
            setupInvoiceButtonListeners();
        }

        // Setup event listeners for invoice action buttons using delegation
        function setupInvoiceButtonListeners() {
            const grid = document.querySelector('.invoices-grid');
            if (!grid) return;

            grid.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;

                const action = button.dataset.action;
                const invoiceNumber = button.dataset.invoice;

                console.log('Invoice button clicked:', action, 'for invoice:', invoiceNumber);

                switch(action) {
                    case 'view':
                        viewInvoice(invoiceNumber);
                        break;
                    case 'print':
                        printInvoice(invoiceNumber);
                        break;
                    case 'approve':
                        approveInvoice(invoiceNumber);
                        break;
                }
            });
        }

        function loadInvoiceCharts(invoices) {
            if (!invoices || invoices.length === 0) {
                console.log('No invoices data available for charts');
                return;
            }

            // Invoices Status Chart
            const statusCounts = {
                'draft': 0,
                'approved': 0,
                'paid': 0,
                'delivered': 0
            };

            invoices.forEach(invoice => {
                const status = invoice.status || 'draft';
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                } else {
                    statusCounts.draft++;
                }
            });

            const statusData = [{
                values: [statusCounts.draft, statusCounts.approved, statusCounts.paid, statusCounts.delivered],
                labels: ['مسودة', 'معتمدة', 'مدفوعة', 'مسلمة'],
                type: 'pie',
                marker: {
                    colors: ['#6b7280', '#3b82f6', '#10b981', '#8b5cf6']
                },
                textinfo: 'label+percent',
                textposition: 'outside',
                hovertemplate: '%{label}: %{value} فاتورة (%{percent})<extra></extra>'
            }];

            const statusLayout = {
                margin: { t: 0, b: 0, l: 0, r: 0 },
                font: { family: 'Cairo, sans-serif', size: 14 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.1,
                    x: 0.5,
                    xanchor: 'center'
                }
            };

            Plotly.newPlot('invoicesStatusChart', statusData, statusLayout, {responsive: true});

            // Revenue Chart - Monthly revenue for the last 6 months
            const monthlyRevenue = {};
            const currentDate = new Date();

            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = date.toLocaleDateString('ar-SA', { month: 'long', year: 'numeric' });
                monthlyRevenue[monthKey] = 0;
            }

            invoices.forEach(invoice => {
                if (invoice.status === 'paid' && invoice.created_at) {
                    const invoiceDate = new Date(invoice.created_at);
                    const monthKey = invoiceDate.toLocaleDateString('ar-SA', { month: 'long', year: 'numeric' });
                    if (monthlyRevenue.hasOwnProperty(monthKey)) {
                        monthlyRevenue[monthKey] += parseFloat(invoice.total_amount) || 0;
                    }
                }
            });

            const revenueLabels = Object.keys(monthlyRevenue);
            const revenueValues = Object.values(monthlyRevenue);

            const revenueData = [{
                x: revenueLabels,
                y: revenueValues,
                type: 'bar',
                name: 'الإيرادات (ليرة سورية)',
                marker: {
                    color: '#10b981',
                    line: {
                        color: '#059669',
                        width: 1
                    }
                },
                hovertemplate: '%{x}: %{y:,.0f} ليرة سورية<extra></extra>'
            }];

            const revenueLayout = {
                margin: { t: 20, r: 20, b: 50, l: 50 },
                font: { family: 'Cairo, sans-serif', size: 12 },
                xaxis: {
                    title: 'الشهر',
                    tickangle: -45
                },
                yaxis: {
                    title: 'الإيرادات (ليرة سورية)',
                    tickformat: ',.0f'
                },
                showlegend: false
            };

            Plotly.newPlot('invoicesRevenueChart', revenueData, revenueLayout, {responsive: true});
        }

        function setupEventListeners() {
            // Setup initial invoice item event listeners
            setupInitialInvoiceItem();

            // Setup invoice button listeners using event delegation
            setupInvoiceButtonListeners();

            // Add event listeners for dynamic calculations
            document.addEventListener('input', function(e) {
                if (e.target.matches('input[placeholder="الكمية"], input[placeholder="السعر"]')) {
                    calculateInvoiceTotals();
                }
            });

            // Setup form validation and dynamic updates
            const invoiceForm = document.getElementById('invoiceForm');
            if (invoiceForm) {
                invoiceForm.addEventListener('submit', function(e) {
                    const orderId = document.getElementById('invoiceOrderId').value;
                    if (!orderId) {
                        e.preventDefault();
                        showMessage('error', 'يجب اختيار طلب مرتبط بالفاتورة');
                        return false;
                    }
                });
            }
        }

        function setupInitialInvoiceItem() {
            const container = document.getElementById('invoiceItemsContainer');
            if (!container) return;

            const firstItem = container.querySelector('.invoice-item');
            if (!firstItem) return;

            const quantityInput = firstItem.querySelector('.quantity-input');
            const priceInput = firstItem.querySelector('.price-input');
            const totalInput = firstItem.querySelector('.total-input');
            const removeBtn = firstItem.querySelector('.remove-item');

            if (quantityInput && priceInput && totalInput) {
                quantityInput.addEventListener('input', function() {
                    calculateItemTotal(quantityInput, priceInput, totalInput);
                });

                priceInput.addEventListener('input', function() {
                    calculateItemTotal(quantityInput, priceInput, totalInput);
                });

                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        firstItem.remove();
                        calculateInvoiceTotals();
                    });
                }
            }

            // Calculate initial totals
            calculateInvoiceTotals();
        }

        // Update invoice statistics based on real data
        function updateInvoiceStatistics(invoices) {
            if (!invoices || invoices.length === 0) {
                document.getElementById('totalInvoices').textContent = '0';
                document.getElementById('draftInvoices').textContent = '0';
                document.getElementById('approvedInvoices').textContent = '0';
                document.getElementById('paidInvoices').textContent = '0';
                document.getElementById('deliveredInvoices').textContent = '0';
                return;
            }

            const stats = {
                total: invoices.length,
                draft: invoices.filter(inv => inv.status === 'draft').length,
                approved: invoices.filter(inv => inv.status === 'approved').length,
                paid: invoices.filter(inv => inv.status === 'paid').length,
                delivered: invoices.filter(inv => inv.status === 'delivered').length
            };

            document.getElementById('totalInvoices').textContent = stats.total;
            document.getElementById('draftInvoices').textContent = stats.draft;
            document.getElementById('approvedInvoices').textContent = stats.approved;
            document.getElementById('paidInvoices').textContent = stats.paid;
            document.getElementById('deliveredInvoices').textContent = stats.delivered;
        }

        // Helper functions
        function getStatusClass(status) {
            const classes = {
                'draft': 'bg-gray-500 text-white',
                'approved': 'bg-blue-500 text-white',
                'paid': 'bg-green-500 text-white',
                'delivered': 'bg-purple-500 text-white',
                'cancelled': 'bg-red-500 text-white'
            };
            return classes[status] || 'bg-gray-500 text-white';
        }

        function getStatusText(status) {
            const texts = {
                'draft': 'مسودة',
                'approved': 'معتمدة',
                'paid': 'مدفوعة',
                'delivered': 'مسلمة',
                'cancelled': 'ملغية'
            };
            return texts[status] || 'غير محدد';
        }

        function calculateInvoiceTotals() {
            console.log('Calculating invoice totals...');

            const items = document.querySelectorAll('#invoiceItemsContainer .invoice-item');
            let subtotal = 0;

            items.forEach(item => {
                const quantityInput = item.querySelector('.quantity-input');
                const priceInput = item.querySelector('.price-input');
                const totalInput = item.querySelector('.total-input');

                if (quantityInput && priceInput && totalInput) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    const total = quantity * price;

                    totalInput.value = total.toFixed(2);
                    subtotal += total;
                }
            });

            const taxAmount = subtotal * 0.15; // 15% tax
            const totalAmount = subtotal + taxAmount;

            const subtotalElement = document.getElementById('subtotalAmount');
            const taxElement = document.getElementById('taxAmount');
            const totalElement = document.getElementById('totalAmount');

            if (subtotalElement) subtotalElement.value = subtotal.toFixed(2);
            if (taxElement) taxElement.value = taxAmount.toFixed(2);
            if (totalElement) totalElement.value = totalAmount.toFixed(2);

            console.log('Totals calculated:', { subtotal, taxAmount, totalAmount });
        }

        // Seed sample invoices data
        async function seedSampleInvoices() {
            try {
                console.log('=== SEED SAMPLE INVOICES BUTTON CLICKED ===');
                console.log('Current user type:', currentUser.userType);
                console.log('Making API call to /api/invoices/seed');

                const response = await fetch('/api/invoices/seed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('Seed response status:', response.status);
                const result = await response.json();
                console.log('Seed response data:', result);

                if (response.ok) {
                    showMessage('success', 'تم إضافة البيانات التجريبية بنجاح');
                    loadInvoicesData(); // Reload the invoices list
                } else {
                    if (response.status === 403) {
                        showMessage('error', 'فقط المدير يمكنه إضافة البيانات التجريبية');
                    } else {
                        showMessage('error', result.message || 'خطأ في إضافة البيانات التجريبية');
                    }
                }
            } catch (error) {
                console.error('Error seeding invoices:', error);
                showMessage('error', 'حدث خطأ أثناء إضافة البيانات التجريبية');
            }
        }

        function showInvoiceAnalytics() {
            alert('سيتم عرض التحليلات المتقدمة للفواتير - سيتم تطويرها قريباً');
        }

        function showCreateInvoiceModal() {
            console.log('=== CREATE INVOICE BUTTON CLICKED ===');
            console.log('Opening create invoice modal...');

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const dueDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            const dateInput = document.getElementById('invoiceDate');
            const dueDateInput = document.getElementById('invoiceDueDate');

            if (dateInput) dateInput.value = today;
            if (dueDateInput) dueDateInput.value = dueDate;

            // Show modal
            const modal = document.getElementById('createInvoiceModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                console.log('Modal opened successfully');

                // Setup form for new invoice
                setupInvoiceForm();
            } else {
                console.error('Create invoice modal not found');
                showMessage('error', 'خطأ في العثور على نافذة إنشاء الفاتورة');
            }
        }

        function setupInvoiceForm() {
            // Clear form
            const form = document.getElementById('invoiceForm');
            if (form) {
                form.reset();
                form.dataset.invoiceId = '';
            }

            // Setup invoice items
            const container = document.getElementById('invoiceItemsContainer');
            if (container) {
                container.innerHTML = `
                    <div class="invoice-item mb-4">
                        <div class="grid grid-cols-12 gap-4">
                            <div class="col-span-4">
                                <input type="text" placeholder="اسم المادة" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="col-span-2">
                                <input type="number" placeholder="الكمية" class="w-full p-2 border border-gray-300 rounded-lg quantity-input" required min="1" step="1">
                            </div>
                            <div class="col-span-3">
                                <input type="number" placeholder="السعر" class="w-full p-2 border border-gray-300 rounded-lg price-input" required min="0" step="0.01">
                            </div>
                            <div class="col-span-2">
                                <input type="number" placeholder="الإجمالي" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 total-input" readonly>
                            </div>
                            <div class="col-span-1">
                                <button type="button" class="text-red-600 hover:text-red-800 p-2 remove-item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Setup event listeners for the initial item
                setupInitialInvoiceItem();
            }

            // Reset calculations
            setTimeout(() => {
                calculateInvoiceTotals();
            }, 100);
        }

        function closeCreateInvoiceModal() {
            const modal = document.getElementById('createInvoiceModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function addInvoiceItem() {
            const container = document.getElementById('invoiceItemsContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item mb-4';
            itemDiv.innerHTML = `
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-4">
                        <input type="text" placeholder="اسم المادة" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="col-span-2">
                        <input type="number" placeholder="الكمية" class="w-full p-2 border border-gray-300 rounded-lg quantity-input" required min="1" step="1">
                    </div>
                    <div class="col-span-3">
                        <input type="number" placeholder="السعر" class="w-full p-2 border border-gray-300 rounded-lg price-input" required min="0" step="0.01">
                    </div>
                    <div class="col-span-2">
                        <input type="number" placeholder="الإجمالي" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 total-input" readonly>
                    </div>
                    <div class="col-span-1">
                        <button type="button" class="text-red-600 hover:text-red-800 p-2 remove-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            // Add event listeners for calculation
            const quantityInput = itemDiv.querySelector('.quantity-input');
            const priceInput = itemDiv.querySelector('.price-input');
            const totalInput = itemDiv.querySelector('.total-input');
            const removeBtn = itemDiv.querySelector('.remove-item');

            quantityInput.addEventListener('input', function() {
                calculateItemTotal(quantityInput, priceInput, totalInput);
            });

            priceInput.addEventListener('input', function() {
                calculateItemTotal(quantityInput, priceInput, totalInput);
            });

            removeBtn.addEventListener('click', function() {
                itemDiv.remove();
                calculateInvoiceTotals();
            });

            container.appendChild(itemDiv);
        }

        function calculateItemTotal(quantityInput, priceInput, totalInput) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = quantity * price;
            totalInput.value = total.toFixed(2);

            // Recalculate invoice totals
            calculateInvoiceTotals();
        }

        // Create new invoice
        async function createInvoice(event) {
            event.preventDefault();

            console.log('=== CREATE INVOICE FORM SUBMITTED ===');
            console.log('Auth token available:', authToken ? 'YES' : 'NO');

            const orderId = document.getElementById('invoiceOrderId').value;
            if (!orderId) {
                showMessage('error', 'يجب اختيار طلب مرتبط بالفاتورة');
                return;
            }

            // Collect invoice items
            const items = [];
            const itemElements = document.querySelectorAll('#invoiceItemsContainer .invoice-item');

            itemElements.forEach(item => {
                const materialName = item.querySelector('input[placeholder="اسم المادة"]').value;
                const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
                const unitPrice = parseFloat(item.querySelector('.price-input').value) || 0;

                if (materialName && quantity > 0 && unitPrice > 0) {
                    items.push({
                        material_name: materialName,
                        quantity: quantity,
                        unit_price: unitPrice
                    });
                }
            });

            if (items.length === 0) {
                showMessage('error', 'يجب إضافة عنصر واحد على الأقل');
                return;
            }

            const invoiceData = {
                order_id: parseInt(orderId),
                customer_name: document.getElementById('invoiceCustomerName').value,
                items: items,
                cutting_fee: 0,
                discount: 0,
                notes: ''
            };

            console.log('Invoice data being sent:', invoiceData);

            try {
                const response = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(invoiceData)
                });

                console.log('Create invoice response status:', response.status);
                const result = await response.json();
                console.log('Create invoice response data:', result);

                if (response.ok) {
                    showMessage('success', 'تم إنشاء الفاتورة بنجاح');
                    closeCreateInvoiceModal();
                    loadInvoicesData(); // Reload the invoices list
                } else {
                    showMessage('error', result.errors ? result.errors.map(e => e.msg).join(', ') : result.message || 'خطأ في إنشاء الفاتورة');
                }
            } catch (error) {
                console.error('Error creating invoice:', error);
                showMessage('error', 'حدث خطأ أثناء إنشاء الفاتورة');
            }
        }

        // View invoice details
        async function viewInvoice(invoiceNumber) {
            try {
                console.log('Viewing invoice:', invoiceNumber);

                // Find invoice data from local cache first
                const invoice = allInvoices.find(inv => inv.invoice_number === invoiceNumber);
                if (!invoice) {
                    showMessage('error', 'الفاتورة غير موجودة');
                    return;
                }

                // Create or show invoice details modal
                showInvoiceDetailsModal(invoice);

            } catch (error) {
                console.error('Error viewing invoice:', error);
                showMessage('error', 'حدث خطأ أثناء عرض تفاصيل الفاتورة');
            }
        }

        function showInvoiceDetailsModal(invoice) {
            // Remove existing modal if any
            const existingModal = document.getElementById('invoiceDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50';
            modal.id = 'invoiceDetailsModal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4 border-b rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-white">تفاصيل الفاتورة ${invoice.invoice_number}</h3>
                            <div class="flex items-center space-x-3">
                                <button onclick="printInvoice('${invoice.invoice_number}')" class="text-white hover:text-gray-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                    <i class="fas fa-print text-lg"></i>
                                </button>
                                <button onclick="closeInvoiceDetailsModal()" class="text-white hover:text-gray-300 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Invoice Information -->
                            <div>
                                <h4 class="font-medium text-gray-800 mb-4">معلومات الفاتورة</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">رقم الفاتورة:</span>
                                        <span class="font-medium">${invoice.invoice_number}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">اسم الزبون:</span>
                                        <span class="font-medium">${invoice.customer_name}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">رقم الطلب:</span>
                                        <span class="font-medium">${invoice.order_number || 'غير محدد'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">تاريخ الإنشاء:</span>
                                        <span class="font-medium">${invoice.created_at ? new Date(invoice.created_at).toLocaleDateString('ar-SA') : 'غير محدد'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">الحالة:</span>
                                        <span class="font-medium ${getStatusClass(invoice.status)}">${getStatusText(invoice.status)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">المبلغ الإجمالي:</span>
                                        <span class="font-bold text-lg text-green-600">${invoice.total_amount ? invoice.total_amount.toLocaleString() + ' ليرة سورية' : 'غير محدد'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Financial Details -->
                            <div>
                                <h4 class="font-medium text-gray-800 mb-4">التفاصيل المالية</h4>
                                <div class="space-y-3">
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-600">المجموع الفرعي:</span>
                                            <span class="font-medium">${invoice.subtotal ? invoice.subtotal.toLocaleString() : '0'} ليرة سورية</span>
                                        </div>
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-600">الضريبة (15%):</span>
                                            <span class="font-medium">${invoice.tax ? invoice.tax.toLocaleString() : '0'} ليرة سورية</span>
                                        </div>
                                        <div class="flex justify-between text-lg font-bold text-green-600 border-t pt-2">
                                            <span>الإجمالي:</span>
                                            <span>${invoice.total_amount ? invoice.total_amount.toLocaleString() : '0'} ليرة سورية</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-between items-center mt-8 pt-6 border-t">
                            <div class="flex space-x-4">
                                ${invoice.status === 'draft' ? `<button onclick="approveInvoiceFromModal('${invoice.invoice_number}')" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-all duration-200">
                                    <i class="fas fa-check ml-2"></i>اعتماد الفاتورة
                                </button>` : ''}
                                ${invoice.status === 'approved' ? `<button onclick="markInvoiceAsPaid('${invoice.invoice_number}')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200">
                                    <i class="fas fa-dollar-sign ml-2"></i>تحديد كمدفوعة
                                </button>` : ''}
                                <button onclick="editInvoice('${invoice.invoice_number}')" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-all duration-200">
                                    <i class="fas fa-edit ml-2"></i>تعديل
                                </button>
                            </div>
                            <button onclick="closeInvoiceDetailsModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            console.log('Invoice details modal opened');
        }

        function closeInvoiceDetailsModal() {
            const modal = document.getElementById('invoiceDetailsModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modal.remove();
            }
        }

        async function approveInvoiceFromModal(invoiceNumber) {
            await approveInvoice(invoiceNumber);
            closeInvoiceDetailsModal();
        }

        async function markInvoiceAsPaid(invoiceNumber) {
            try {
                const invoice = allInvoices.find(inv => inv.invoice_number === invoiceNumber);
                if (!invoice) {
                    showMessage('error', 'الفاتورة غير موجودة');
                    return;
                }

                const response = await fetch(`/api/invoices/${invoice.id}/pay`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        status: 'paid',
                        paid_at: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    showMessage('success', 'تم تحديد الفاتورة كمدفوعة بنجاح');
                    closeInvoiceDetailsModal();
                    loadInvoicesData(); // Reload to show updated status
                } else {
                    const errorData = await response.json();
                    showMessage('error', errorData.message || 'خطأ في تحديد الفاتورة كمدفوعة');
                }
            } catch (error) {
                console.error('Error marking invoice as paid:', error);
                showMessage('error', 'حدث خطأ أثناء تحديد الفاتورة كمدفوعة');
            }
        }

        async function editInvoice(invoiceNumber) {
            try {
                console.log('Editing invoice:', invoiceNumber);

                // Find invoice data from local cache
                const invoice = allInvoices.find(inv => inv.invoice_number === invoiceNumber);
                if (!invoice) {
                    showMessage('error', 'الفاتورة غير موجودة');
                    return;
                }

                // Close details modal if open
                closeInvoiceDetailsModal();

                // Show edit modal
                showEditInvoiceModal(invoice);

            } catch (error) {
                console.error('Error editing invoice:', error);
                showMessage('error', 'حدث خطأ أثناء تحضير تعديل الفاتورة');
            }
        }

        function showEditInvoiceModal(invoice) {
            // Remove existing edit modal if any
            const existingModal = document.getElementById('editInvoiceModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50';
            modal.id = 'editInvoiceModal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="bg-gradient-to-r from-gray-500 to-gray-600 px-6 py-4 border-b rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-white">تعديل الفاتورة ${invoice.invoice_number}</h3>
                            <div class="flex items-center space-x-3">
                                <button onclick="goBackFromModal('editInvoiceModal')" class="text-white hover:text-gray-200 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                    <i class="fas fa-arrow-right text-lg"></i>
                                </button>
                                <button onclick="closeEditInvoiceModal()" class="text-white hover:text-gray-300 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <form id="editInvoiceForm" onsubmit="updateInvoice(event)" class="p-6">
                        <input type="hidden" id="editInvoiceId" value="${invoice.id}">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Invoice Details -->
                            <div>
                                <h4 class="font-medium text-gray-800 mb-4">تفاصيل الفاتورة</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">رقم الفاتورة</label>
                                        <input type="text" id="editInvoiceNumber" value="${invoice.invoice_number}" required class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">اسم الزبون</label>
                                        <input type="text" id="editInvoiceCustomerName" value="${invoice.customer_name}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
                                        <input type="text" id="editInvoiceCustomerPhone" value="${invoice.customer_phone || ''}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">العنوان</label>
                                        <textarea id="editInvoiceCustomerAddress" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${invoice.customer_address || ''}</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Invoice Items -->
                            <div>
                                <h4 class="font-medium text-gray-800 mb-4">عناصر الفاتورة</h4>
                                <div id="editInvoiceItemsContainer">
                                    ${invoice.items && invoice.items.map((item, index) => `
                                        <div class="invoice-item mb-4" data-item-id="${item.id}">
                                            <div class="grid grid-cols-12 gap-4">
                                                <div class="col-span-4">
                                                    <input type="text" placeholder="اسم المادة" value="${item.material_name}" class="w-full p-2 border border-gray-300 rounded-lg edit-item-name" required>
                                                </div>
                                                <div class="col-span-2">
                                                    <input type="number" placeholder="الكمية" value="${item.quantity}" class="w-full p-2 border border-gray-300 rounded-lg edit-quantity-input" required min="1" step="1">
                                                </div>
                                                <div class="col-span-3">
                                                    <input type="number" placeholder="السعر" value="${item.unit_price}" class="w-full p-2 border border-gray-300 rounded-lg edit-price-input" required min="0" step="0.01">
                                                </div>
                                                <div class="col-span-2">
                                                    <input type="number" placeholder="الإجمالي" value="${item.total_price}" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 edit-total-input" readonly>
                                                </div>
                                                <div class="col-span-1">
                                                    <button type="button" class="text-red-600 hover:text-red-800 p-2 edit-remove-item">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button type="button" onclick="addEditInvoiceItem()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full">
                                    <i class="fas fa-plus ml-2"></i>إضافة عنصر
                                </button>
                            </div>
                        </div>

                        <!-- Tax and Total -->
                        <div class="mt-8">
                            <div class="tax-calculation">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ قبل الضريبة</label>
                                        <input type="number" id="editSubtotalAmount" value="${invoice.subtotal || 0}" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">رسوم القص</label>
                                        <input type="number" id="editCuttingFee" value="${invoice.cutting_fee || 0}" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">الخصم</label>
                                        <input type="number" id="editDiscount" value="${invoice.discount || 0}" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">الضريبة (15%)</label>
                                        <input type="number" id="editTaxAmount" value="${invoice.tax || 0}" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ الإجمالي</label>
                                        <input type="number" id="editTotalAmount" value="${invoice.total_amount || 0}" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 font-bold text-lg">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 mt-8">
                            <button type="button" onclick="closeEditInvoiceModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                إلغاء
                            </button>
                            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-save ml-2"></i>حفظ التغييرات
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Setup event listeners for edit form
            setupEditInvoiceForm();
        }

        function setupEditInvoiceForm() {
            // Setup event listeners for calculations
            document.addEventListener('input', function(e) {
                if (e.target.matches('.edit-quantity-input, .edit-price-input, #editCuttingFee, #editDiscount')) {
                    calculateEditInvoiceTotals();
                }
            });

            // Setup remove item buttons
            document.querySelectorAll('.edit-remove-item').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.invoice-item').remove();
                    calculateEditInvoiceTotals();
                });
            });
        }

        function addEditInvoiceItem() {
            const container = document.getElementById('editInvoiceItemsContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item mb-4';
            itemDiv.innerHTML = `
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-4">
                        <input type="text" placeholder="اسم المادة" class="w-full p-2 border border-gray-300 rounded-lg edit-item-name" required>
                    </div>
                    <div class="col-span-2">
                        <input type="number" placeholder="الكمية" class="w-full p-2 border border-gray-300 rounded-lg edit-quantity-input" required min="1" step="1">
                    </div>
                    <div class="col-span-3">
                        <input type="number" placeholder="السعر" class="w-full p-2 border border-gray-300 rounded-lg edit-price-input" required min="0" step="0.01">
                    </div>
                    <div class="col-span-2">
                        <input type="number" placeholder="الإجمالي" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 edit-total-input" readonly>
                    </div>
                    <div class="col-span-1">
                        <button type="button" class="text-red-600 hover:text-red-800 p-2 edit-remove-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            // Add event listeners for calculation
            const quantityInput = itemDiv.querySelector('.edit-quantity-input');
            const priceInput = itemDiv.querySelector('.edit-price-input');
            const totalInput = itemDiv.querySelector('.edit-total-input');
            const removeBtn = itemDiv.querySelector('.edit-remove-item');

            quantityInput.addEventListener('input', function() {
                calculateEditItemTotal(quantityInput, priceInput, totalInput);
            });

            priceInput.addEventListener('input', function() {
                calculateEditItemTotal(quantityInput, priceInput, totalInput);
            });

            removeBtn.addEventListener('click', function() {
                itemDiv.remove();
                calculateEditInvoiceTotals();
            });

            container.appendChild(itemDiv);
        }

        function calculateEditItemTotal(quantityInput, priceInput, totalInput) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = quantity * price;
            totalInput.value = total.toFixed(2);

            // Recalculate invoice totals
            calculateEditInvoiceTotals();
        }

        function calculateEditInvoiceTotals() {
            console.log('Calculating edit invoice totals...');

            const items = document.querySelectorAll('#editInvoiceItemsContainer .invoice-item');
            let subtotal = 0;

            items.forEach(item => {
                const quantityInput = item.querySelector('.edit-quantity-input');
                const priceInput = item.querySelector('.edit-price-input');
                const totalInput = item.querySelector('.edit-total-input');

                if (quantityInput && priceInput && totalInput) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    const total = quantity * price;

                    totalInput.value = total.toFixed(2);
                    subtotal += total;
                }
            });

            const cuttingFee = parseFloat(document.getElementById('editCuttingFee').value) || 0;
            const discount = parseFloat(document.getElementById('editDiscount').value) || 0;
            const taxAmount = (subtotal - discount + cuttingFee) * 0.15;
            const totalAmount = subtotal - discount + cuttingFee + taxAmount;

            document.getElementById('editSubtotalAmount').value = subtotal.toFixed(2);
            document.getElementById('editTaxAmount').value = taxAmount.toFixed(2);
            document.getElementById('editTotalAmount').value = totalAmount.toFixed(2);

            console.log('Edit totals calculated:', { subtotal, cuttingFee, discount, taxAmount, totalAmount });
        }

        function closeEditInvoiceModal() {
            const modal = document.getElementById('editInvoiceModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modal.remove();
            }
        }

        // Update invoice
        async function updateInvoice(event) {
            event.preventDefault();

            console.log('=== UPDATE INVOICE FORM SUBMITTED ===');

            const invoiceId = document.getElementById('editInvoiceId').value;
            if (!invoiceId) {
                showMessage('error', 'معرف الفاتورة مفقود');
                return;
            }

            // Collect invoice items
            const items = [];
            const itemElements = document.querySelectorAll('#editInvoiceItemsContainer .invoice-item');

            itemElements.forEach(item => {
                const materialName = item.querySelector('.edit-item-name').value;
                const quantity = parseFloat(item.querySelector('.edit-quantity-input').value) || 0;
                const unitPrice = parseFloat(item.querySelector('.edit-price-input').value) || 0;

                if (materialName && quantity > 0 && unitPrice > 0) {
                    items.push({
                        material_name: materialName,
                        quantity: quantity,
                        unit_price: unitPrice
                    });
                }
            });

            if (items.length === 0) {
                showMessage('error', 'يجب إضافة عنصر واحد على الأقل');
                return;
            }

            const invoiceData = {
                customer_name: document.getElementById('editInvoiceCustomerName').value,
                customer_phone: document.getElementById('editInvoiceCustomerPhone').value,
                customer_address: document.getElementById('editInvoiceCustomerAddress').value,
                items: items,
                cutting_fee: parseFloat(document.getElementById('editCuttingFee').value) || 0,
                discount: parseFloat(document.getElementById('editDiscount').value) || 0,
                notes: ''
            };

            console.log('Update invoice data being sent:', invoiceData);

            try {
                const response = await fetch(`/api/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(invoiceData)
                });

                console.log('Update invoice response status:', response.status);
                const result = await response.json();
                console.log('Update invoice response data:', result);

                if (response.ok) {
                    showMessage('success', 'تم تحديث الفاتورة بنجاح');
                    closeEditInvoiceModal();
                    loadInvoicesData(); // Reload the invoices list
                } else {
                    showMessage('error', result.errors ? result.errors.map(e => e.msg).join(', ') : result.message || 'خطأ في تحديث الفاتورة');
                }
            } catch (error) {
                console.error('Error updating invoice:', error);
                showMessage('error', 'حدث خطأ أثناء تحديث الفاتورة');
            }
        }

        // Export invoices to PDF
        function exportInvoicesPDF() {
            try {
                if (allInvoices.length === 0) {
                    showMessage('warning', 'لا توجد فواتير للتصدير');
                    return;
                }

                showMessage('info', 'جاري إعداد ملف PDF...');

                // Create PDF content
                const pdfContent = generateInvoicesPDFContent(allInvoices);

                // Create blob and download
                const blob = new Blob([pdfContent], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `invoices_report_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showMessage('success', 'تم تصدير الفواتير إلى PDF بنجاح');

            } catch (error) {
                console.error('Error exporting PDF:', error);
                showMessage('error', 'حدث خطأ أثناء تصدير PDF');
            }
        }

        // Generate PDF content for all invoices
        function generateInvoicesPDFContent(invoices) {
            const currentDate = new Date().toLocaleDateString('ar-SA');
            const totalAmount = invoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);

            let content = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تقرير الفواتير</title>
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: white;
            color: #333;
            font-size: 12px;
            line-height: 1.4;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        .header .subtitle {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }
        .summary-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .invoice-card {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            page-break-inside: avoid;
        }
        .invoice-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .invoice-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .invoice-meta {
            text-align: left;
        }
        .invoice-meta-item {
            margin-bottom: 3px;
            font-size: 11px;
        }
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 11px;
        }
        .invoice-table th,
        .invoice-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: right;
        }
        .invoice-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .invoice-table .total-row {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .invoice-table .grand-total {
            background-color: #333;
            color: white;
            font-size: 12px;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        .status-draft { background: #e2e8f0; color: #475569; }
        .status-approved { background: #dbeafe; color: #1e40af; }
        .status-paid { background: #dcfce7; color: #166534; }
        .status-delivered { background: #f3e8ff; color: #7c3aed; }
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 10px;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        @media print {
            body { margin: 0; padding: 10px; }
            .invoice-card { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>تقرير الفواتير الشامل</h1>
        <div class="subtitle">نظام إدارة المستودعات المتكامل</div>
        <div class="subtitle">تاريخ التقرير: ${currentDate}</div>
    </div>

    <div class="summary">
        <div class="summary-item">
            <div class="summary-label">إجمالي الفواتير</div>
            <div class="summary-value">${invoices.length}</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">إجمالي المبلغ</div>
            <div class="summary-value">${totalAmount.toLocaleString()} ليرة سورية</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">المدفوعة</div>
            <div class="summary-value">${invoices.filter(inv => inv.status === 'paid').length}</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">قيد الانتظار</div>
            <div class="summary-value">${invoices.filter(inv => inv.status === 'approved').length}</div>
        </div>
    </div>
`;

            // Add each invoice
            invoices.forEach((invoice, index) => {
                content += `
    <div class="invoice-card">
        <div class="invoice-header">
            <div>
                <div class="invoice-title">فاتورة ${invoice.invoice_number}</div>
                <div class="invoice-meta">
                    <div class="invoice-meta-item">الزبون: ${invoice.customer_name}</div>
                    <div class="invoice-meta-item">رقم الطلب: ${invoice.order_number || 'غير محدد'}</div>
                    <div class="invoice-meta-item">التاريخ: ${invoice.created_at ? new Date(invoice.created_at).toLocaleDateString('ar-SA') : 'غير محدد'}</div>
                </div>
            </div>
            <div class="invoice-meta">
                <div class="invoice-meta-item">
                    الحالة: <span class="status-badge status-${invoice.status}">${getStatusText(invoice.status)}</span>
                </div>
                <div class="invoice-meta-item">المبلغ: ${invoice.total_amount ? parseFloat(invoice.total_amount).toLocaleString() : '0'} ليرة سورية</div>
            </div>
        </div>

        <table class="invoice-table">
            <thead>
                <tr>
                    <th style="width: 40%;">المادة</th>
                    <th style="width: 15%;">الكمية</th>
                    <th style="width: 20%;">سعر الوحدة</th>
                    <th style="width: 25%;">الإجمالي</th>
                </tr>
            </thead>
            <tbody>
`;

                if (invoice.items && invoice.items.length > 0) {
                    invoice.items.forEach(item => {
                        content += `
                <tr>
                    <td>${item.material_name}</td>
                    <td>${item.quantity}</td>
                    <td>${parseFloat(item.unit_price).toLocaleString()}</td>
                    <td>${parseFloat(item.total_price).toLocaleString()}</td>
                </tr>
`;
                    });
                } else {
                    content += `
                <tr>
                    <td colspan="4" style="text-align: center; color: #666;">تفاصيل العناصر غير متوفرة</td>
                </tr>
`;
                }

                content += `
                <tr class="total-row">
                    <td colspan="3">المجموع الفرعي</td>
                    <td>${invoice.subtotal ? parseFloat(invoice.subtotal).toLocaleString() : '0'} ليرة سورية</td>
                </tr>
                ${invoice.tax ? `
                <tr class="total-row">
                    <td colspan="3">الضريبة (15%)</td>
                    <td>${parseFloat(invoice.tax).toLocaleString()} ليرة سورية</td>
                </tr>
                ` : ''}
                <tr class="grand-total">
                    <td colspan="3">الإجمالي</td>
                    <td>${invoice.total_amount ? parseFloat(invoice.total_amount).toLocaleString() : '0'} ليرة سورية</td>
                </tr>
            </tbody>
        </table>
    </div>
`;
            });

            content += `
    <div class="footer">
        <p>تم إنشاء هذا التقرير بواسطة نظام إدارة المستودعات المتكامل</p>
        <p>تاريخ الإنشاء: ${currentDate} - إجمالي الفواتير: ${invoices.length} - إجمالي المبلغ: ${totalAmount.toLocaleString()} ليرة سورية</p>
    </div>
</body>
</html>`;

            return content;
        }

        // Print invoice
        function printInvoice(invoiceNumber) {
            try {
                const invoice = allInvoices.find(inv => inv.invoice_number === invoiceNumber);
                if (!invoice) {
                    showMessage('error', 'الفاتورة غير موجودة');
                    return;
                }

                // Create printable invoice content
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>فاتورة ${invoiceNumber}</title>
                        <style>
                            body {
                                font-family: 'Cairo', sans-serif;
                                margin: 20px;
                                background: white;
                                color: #333;
                            }
                            .invoice-container {
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 20px;
                                border: 2px solid #333;
                                background: white;
                            }
                            .invoice-header {
                                text-align: center;
                                border-bottom: 3px solid #333;
                                padding-bottom: 20px;
                                margin-bottom: 30px;
                            }
                            .invoice-title {
                                font-size: 28px;
                                font-weight: bold;
                                color: #333;
                                margin-bottom: 10px;
                            }
                            .invoice-number {
                                font-size: 18px;
                                color: #666;
                                margin-bottom: 20px;
                            }
                            .invoice-details {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 20px;
                                margin-bottom: 30px;
                            }
                            .detail-section h3 {
                                font-size: 16px;
                                font-weight: bold;
                                color: #333;
                                margin-bottom: 10px;
                                border-bottom: 1px solid #ddd;
                                padding-bottom: 5px;
                            }
                            .detail-item {
                                margin-bottom: 5px;
                                display: flex;
                                justify-content: space-between;
                            }
                            .detail-label {
                                font-weight: 600;
                                color: #555;
                            }
                            .detail-value {
                                color: #333;
                            }
                            .invoice-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 20px 0;
                                font-size: 14px;
                            }
                            .invoice-table th,
                            .invoice-table td {
                                border: 1px solid #333;
                                padding: 10px;
                                text-align: right;
                            }
                            .invoice-table th {
                                background-color: #f5f5f5;
                                font-weight: bold;
                                font-size: 16px;
                            }
                            .invoice-table .total-row {
                                font-weight: bold;
                                background-color: #f0f0f0;
                                font-size: 16px;
                            }
                            .invoice-table .grand-total {
                                background-color: #333;
                                color: white;
                                font-size: 18px;
                            }
                            .invoice-footer {
                                margin-top: 40px;
                                padding-top: 20px;
                                border-top: 2px solid #333;
                                text-align: center;
                                color: #666;
                                font-size: 12px;
                            }
                            .company-info {
                                margin-bottom: 20px;
                                text-align: center;
                            }
                            .company-name {
                                font-size: 20px;
                                font-weight: bold;
                                color: #333;
                                margin-bottom: 5px;
                            }
                            .company-details {
                                color: #666;
                                font-size: 14px;
                            }
                            @media print {
                                body { margin: 0; }
                                .invoice-container { border: none; padding: 10px; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="invoice-container">
                            <!-- Company Information -->
                            <div class="company-info">
                                <div class="company-name">نظام إدارة المستودعات المتكامل</div>
                                <div class="company-details">
                                    نظام إدارة شامل للمستودعات والفواتير والمخزون<br>
                                    تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')} ${new Date().toLocaleTimeString('ar-SA')}
                                </div>
                            </div>

                            <!-- Invoice Header -->
                            <div class="invoice-header">
                                <div class="invoice-title">فاتورة بيع</div>
                                <div class="invoice-number">رقم الفاتورة: ${invoiceNumber}</div>
                            </div>

                            <!-- Invoice Details -->
                            <div class="invoice-details">
                                <div class="detail-section">
                                    <h3>معلومات الزبون</h3>
                                    <div class="detail-item">
                                        <span class="detail-label">الاسم:</span>
                                        <span class="detail-value">${invoice.customer_name}</span>
                                    </div>
                                    ${invoice.customer_phone ? `
                                        <div class="detail-item">
                                            <span class="detail-label">الهاتف:</span>
                                            <span class="detail-value">${invoice.customer_phone}</span>
                                        </div>
                                    ` : ''}
                                    ${invoice.customer_address ? `
                                        <div class="detail-item">
                                            <span class="detail-label">العنوان:</span>
                                            <span class="detail-value">${invoice.customer_address}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="detail-section">
                                    <h3>معلومات الفاتورة</h3>
                                    <div class="detail-item">
                                        <span class="detail-label">رقم الطلب:</span>
                                        <span class="detail-value">${invoice.order_number || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">تاريخ الإصدار:</span>
                                        <span class="detail-value">${invoice.created_at ? new Date(invoice.created_at).toLocaleDateString('ar-SA') : 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">الحالة:</span>
                                        <span class="detail-value">${getStatusText(invoice.status)}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Invoice Items -->
                            <table class="invoice-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40%;">المادة</th>
                                        <th style="width: 15%;">الكمية</th>
                                        <th style="width: 20%;">سعر الوحدة</th>
                                        <th style="width: 25%;">الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoice.items && invoice.items.length > 0 ?
                                        invoice.items.map(item => `
                                            <tr>
                                                <td>${item.material_name}</td>
                                                <td>${item.quantity}</td>
                                                <td>${parseFloat(item.unit_price).toLocaleString()} ليرة سورية</td>
                                                <td>${parseFloat(item.total_price).toLocaleString()} ليرة سورية</td>
                                            </tr>
                                        `).join('')
                                        :
                                        '<tr><td colspan="4" style="text-align: center; color: #666;">تفاصيل العناصر غير متوفرة</td></tr>'
                                    }
                                    <tr class="total-row">
                                        <td colspan="3">المجموع الفرعي</td>
                                        <td>${invoice.subtotal ? parseFloat(invoice.subtotal).toLocaleString() : '0'} ليرة سورية</td>
                                    </tr>
                                    ${invoice.cutting_fee ? `
                                        <tr class="total-row">
                                            <td colspan="3">رسوم القص</td>
                                            <td>${parseFloat(invoice.cutting_fee).toLocaleString()} ليرة سورية</td>
                                        </tr>
                                    ` : ''}
                                    ${invoice.discount ? `
                                        <tr class="total-row">
                                            <td colspan="3">الخصم</td>
                                            <td>-${parseFloat(invoice.discount).toLocaleString()} ليرة سورية</td>
                                        </tr>
                                    ` : ''}
                                    <tr class="total-row">
                                        <td colspan="3">الضريبة (15%)</td>
                                        <td>${invoice.tax ? parseFloat(invoice.tax).toLocaleString() : '0'} ليرة سورية</td>
                                    </tr>
                                    <tr class="grand-total">
                                        <td colspan="3">الإجمالي الكلي</td>
                                        <td>${invoice.total_amount ? parseFloat(invoice.total_amount).toLocaleString() : '0'} ليرة سورية</td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Invoice Footer -->
                            <div class="invoice-footer">
                                <p>شكراً لك على التعامل معنا</p>
                                <p>للاستفسارات، يرجى الاتصال بنا</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error('Error printing invoice:', error);
                showMessage('error', 'حدث خطأ أثناء طباعة الفاتورة');
            }
        }

        // Approve invoice
        async function approveInvoice(invoiceNumber) {
            try {
                console.log('Approving invoice:', invoiceNumber);

                const invoice = allInvoices.find(inv => inv.invoice_number === invoiceNumber);
                if (!invoice) {
                    showMessage('error', 'الفاتورة غير موجودة');
                    return;
                }

                const response = await fetch(`/api/invoices/${invoice.id}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    showMessage('success', 'تم اعتماد الفاتورة بنجاح');
                    loadInvoicesData(); // Reload to show updated status
                } else {
                    const errorData = await response.json();
                    showMessage('error', errorData.message || 'خطأ في اعتماد الفاتورة');
                }
            } catch (error) {
                console.error('Error approving invoice:', error);
                showMessage('error', 'حدث خطأ أثناء اعتماد الفاتورة');
            }
        }

        // Bulk invoice operations
        async function showBulkInvoiceModal() {
            // Create bulk operations modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50';
            modal.id = 'bulkInvoiceModal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full mx-4">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4 border-b rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-white">العمليات المجمعة على الفواتير</h3>
                            <button onclick="closeBulkInvoiceModal()" class="text-white hover:text-gray-300 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-medium text-gray-800 mb-3">اختر العملية المطلوبة</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button onclick="bulkApproveInvoices()" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition-all duration-200">
                                        <i class="fas fa-check text-xl mb-2 block"></i>
                                        اعتماد الفواتير المحددة
                                    </button>
                                    <button onclick="bulkMarkAsPaid()" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition-all duration-200">
                                        <i class="fas fa-dollar-sign text-xl mb-2 block"></i>
                                        تحديد كمدفوعة
                                    </button>
                                    <button onclick="bulkExportInvoices()" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition-all duration-200">
                                        <i class="fas fa-download text-xl mb-2 block"></i>
                                        تصدير الفواتير
                                    </button>
                                    <button onclick="bulkDeleteInvoices()" class="bg-red-600 text-white p-4 rounded-lg hover:bg-red-700 transition-all duration-200">
                                        <i class="fas fa-trash text-xl mb-2 block"></i>
                                        حذف الفواتير
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.classList.remove('hidden');
        }

        function closeBulkInvoiceModal() {
            const modal = document.getElementById('bulkInvoiceModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.remove();
            }
        }

        // Payment processing
        function showPaymentModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50';
            modal.id = 'paymentModal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full mx-4">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4 border-b rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-white">معالجة المدفوعات</h3>
                            <button onclick="closePaymentModal()" class="text-white hover:text-gray-300 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-medium text-gray-800 mb-3">اختر الفاتورة للدفع</h4>
                                <select id="paymentInvoiceSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    <option value="">اختر الفاتورة</option>
                                    ${allInvoices.filter(inv => inv.status === 'approved').map(inv =>
                                        `<option value="${inv.id}">فاتورة ${inv.invoice_number} - ${inv.customer_name} (${inv.total_amount} ليرة سورية)</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="payment-methods">
                                <div class="payment-method" onclick="selectPaymentMethod('cash')">
                                    <div class="payment-icon bg-green-100 text-green-600">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div class="font-medium">نقدي</div>
                                </div>
                                <div class="payment-method" onclick="selectPaymentMethod('bank_transfer')">
                                    <div class="payment-icon bg-blue-100 text-blue-600">
                                        <i class="fas fa-university"></i>
                                    </div>
                                    <div class="font-medium">تحويل بنكي</div>
                                </div>
                                <div class="payment-method" onclick="selectPaymentMethod('check')">
                                    <div class="payment-icon bg-purple-100 text-purple-600">
                                        <i class="fas fa-money-check"></i>
                                    </div>
                                    <div class="font-medium">شيك</div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button onclick="closePaymentModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                    إلغاء
                                </button>
                                <button onclick="processPayment()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    معالجة الدفع
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.classList.remove('hidden');
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.remove();
            }
        }

        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method').forEach(pm => pm.classList.remove('selected'));
            event.target.closest('.payment-method').classList.add('selected');
        }

        // Delivery tracking
        function showDeliveryModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50';
            modal.id = 'deliveryModal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-3xl w-full mx-4">
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4 border-b rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-white">تتبع التسليم</h3>
                            <button onclick="closeDeliveryModal()" class="text-white hover:text-gray-300 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-medium text-gray-800 mb-3">اختر الفاتورة للتسليم</h4>
                                <select id="deliveryInvoiceSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                    <option value="">اختر الفاتورة</option>
                                    ${allInvoices.filter(inv => inv.status === 'paid').map(inv =>
                                        `<option value="${inv.id}">فاتورة ${inv.invoice_number} - ${inv.customer_name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ التسليم</label>
                                    <input type="datetime-local" id="deliveryDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم السائق</label>
                                    <input type="text" id="driverName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="اسم السائق">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات التسليم</label>
                                <textarea id="deliveryNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="أي ملاحظات خاصة بالتسليم"></textarea>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button onclick="closeDeliveryModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                    إلغاء
                                </button>
                                <button onclick="scheduleDelivery()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                    جدولة التسليم
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.classList.remove('hidden');
        }

        function closeDeliveryModal() {
            const modal = document.getElementById('deliveryModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.remove();
            }
        }

        // Tax calculation
        function showTaxModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50';
            modal.id = 'taxModal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full mx-4">
                    <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4 border-b rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-white">حساب الضرائب</h3>
                            <button onclick="closeTaxModal()" class="text-white hover:text-gray-300 p-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-200">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ الأساسي</label>
                                    <input type="number" id="baseAmount" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">نسبة الضريبة (%)</label>
                                    <input type="number" id="taxRate" value="15" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">نوع الضريبة</label>
                                    <select id="taxType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                        <option value="vat">ضريبة القيمة المضافة</option>
                                        <option value="sales">ضريبة المبيعات</option>
                                        <option value="income">ضريبة الدخل</option>
                                    </select>
                                </div>
                            </div>
                            <div class="tax-calculation">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">مبلغ الضريبة</label>
                                        <input type="number" id="calculatedTax" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ الإجمالي</label>
                                        <input type="number" id="totalWithTax" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 font-bold">
                                    </div>
                                    <div>
                                        <button onclick="calculateTax()" class="w-full p-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-all duration-200">
                                            احسب الضريبة
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.classList.remove('hidden');

            // Add event listeners for real-time calculation
            document.getElementById('baseAmount').addEventListener('input', calculateTax);
            document.getElementById('taxRate').addEventListener('input', calculateTax);
        }

        function closeTaxModal() {
            const modal = document.getElementById('taxModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.remove();
            }
        }

        function calculateTax() {
            const baseAmount = parseFloat(document.getElementById('baseAmount').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = (baseAmount * taxRate) / 100;
            const totalAmount = baseAmount + taxAmount;

            document.getElementById('calculatedTax').value = taxAmount.toFixed(2);
            document.getElementById('totalWithTax').value = totalAmount.toFixed(2);
        }

        // Bulk operations implementations
        async function bulkApproveInvoices() {
            const selectedInvoices = allInvoices.filter(inv => inv.status === 'draft');
            if (selectedInvoices.length === 0) {
                showMessage('warning', 'لا توجد فواتير مسودة للاعتماد');
                return;
            }

            try {
                for (const invoice of selectedInvoices) {
                    await fetch(`/api/invoices/${invoice.id}/approve`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            status: 'approved',
                            approved_by: currentUser.id
                        })
                    });
                }
                showMessage('success', `تم اعتماد ${selectedInvoices.length} فاتورة بنجاح`);
                closeBulkInvoiceModal();
                loadInvoicesData();
            } catch (error) {
                console.error('Error in bulk approval:', error);
                showMessage('error', 'حدث خطأ أثناء العملية المجمعة');
            }
        }

        async function bulkMarkAsPaid() {
            const selectedInvoices = allInvoices.filter(inv => inv.status === 'approved');
            if (selectedInvoices.length === 0) {
                showMessage('warning', 'لا توجد فواتير معتمدة لتحديدها كمدفوعة');
                return;
            }

            try {
                for (const invoice of selectedInvoices) {
                    await fetch(`/api/invoices/${invoice.id}/pay`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            status: 'paid',
                            paid_at: new Date().toISOString()
                        })
                    });
                }
                showMessage('success', `تم تحديد ${selectedInvoices.length} فاتورة كمدفوعة`);
                closeBulkInvoiceModal();
                loadInvoicesData();
            } catch (error) {
                console.error('Error in bulk payment marking:', error);
                showMessage('error', 'حدث خطأ أثناء العملية المجمعة');
            }
        }

        function bulkExportInvoices() {
            // Export all invoices data
            const dataStr = JSON.stringify(allInvoices, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `invoices_export_${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showMessage('success', 'تم تصدير بيانات الفواتير بنجاح');
            closeBulkInvoiceModal();
        }

        function bulkDeleteInvoices() {
            if (confirm('هل أنت متأكد من حذف جميع الفواتير؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                showMessage('warning', 'حذف جميع الفواتير - سيتم تطوير هذه الوظيفة قريباً');
            }
        }

        function processPayment() {
            const invoiceId = document.getElementById('paymentInvoiceSelect').value;
            const selectedMethod = document.querySelector('.payment-method.selected');
            if (!invoiceId || !selectedMethod) {
                showMessage('error', 'يرجى اختيار الفاتورة وطريقة الدفع');
                return;
            }

            const method = selectedMethod.textContent.trim();
            showMessage('success', `تم معالجة الدفع بنجاح باستخدام ${method}`);
            closePaymentModal();
        }

        function scheduleDelivery() {
            const invoiceId = document.getElementById('deliveryInvoiceSelect').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const driverName = document.getElementById('driverName').value;

            if (!invoiceId || !deliveryDate || !driverName) {
                showMessage('error', 'يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            showMessage('success', `تم جدولة التسليم بنجاح لتاريخ ${new Date(deliveryDate).toLocaleDateString('ar-SA')} مع السائق ${driverName}`);
            closeDeliveryModal();
        }

        // Go back from modal function
        function goBackFromModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Message display function
        function showMessage(type, message) {
            console.log(`Invoice message (${type}):`, message);

            // Create message element
            const messageEl = document.createElement('div');
            messageEl.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-300' :
                type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-300' :
                'bg-blue-100 text-blue-800 border border-blue-300'
            }`;

            messageEl.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    } ml-2"></i>
                    <span class="text-sm">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="mr-auto text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(messageEl);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>